name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "ðŸš€ REPARO TOTAL E DEPLOY DEFINITIVO"
          APP_PATH="/home/bhseletrica-crm/htdocs/crm.bhseletrica.com.br"
          
          # 1. Resetar Ownership de TUDO como root
          echo "ðŸ”’ Resetando ownership para bhs-crm..."
          chown -R bhs-crm:bhseletrica-crm "$APP_PATH" /home/bhseletrica-crm
          chmod -R 775 "$APP_PATH"
          chmod a+x /home/bhseletrica-crm /home/bhseletrica-crm/htdocs
          
          cd "$APP_PATH" || exit 1
          
          # 2. Sync CÃ³digo (como root para garantir permissÃ£o no .git)
          git config --global --add safe.directory "$APP_PATH"
          git reset --hard HEAD
          git pull origin main
          
          # 3. Garantir que o .env existe (Backup/Restore)
          [ -f "backend/.env" ] || cp /tmp/backend.env.backup backend/.env 2>/dev/null || true
          
          # 4. Backend (InstalaÃ§Ã£o limpa)
          echo "âš™ï¸ Backend Update..."
          cd backend
          rm -rf node_modules package-lock.json
          # Rodar install como o usuÃ¡rio correto
          su - bhs-crm -c "cd $APP_PATH/backend && source ~/.nvm/nvm.sh && npm install"
          # Restart PM2
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 restart crm-backend || pm2 start server.js --name crm-backend"
          
          # 5. Frontend (Build limpo)
          echo "ðŸŽ¨ Frontend Build..."
          cd ../frontend
          rm -rf build node_modules package-lock.json
          su - bhs-crm -c "cd $APP_PATH/frontend && source ~/.nvm/nvm.sh && npm install && npm run build"
          
          # 6. PermissÃµes de SaÃ­da
          echo "ðŸ”’ PermissÃµes finais..."
          chown -R bhs-crm:bhseletrica-crm build
          chmod -R 755 build
          
          # 7. Nginx final
          nginx -t && systemctl restart nginx
          
          # 8. Capturar Logs de Erro (para ler via browser em caso de 500)
          echo "window.NGINX_LOGS = \`" > build/static/js/error-logs.js
          tail -n 100 /var/log/nginx/error.log >> build/static/js/error-logs.js 2>&1
          echo "\`;" >> build/static/js/error-logs.js
          chmod 644 build/static/js/error-logs.js
          
          echo "âœ… DEPLOY FINALIZADO COM SUCESSO!"
