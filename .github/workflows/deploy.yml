name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "üöÄ DEPLOY CORRETIVO - FIX PERMISSIONS"
          APP_PATH="/home/bhs-crm/htdocs/crm.bhseletrica.com.br"
          
          # 1. Corrigir permiss√µes como root logo no in√≠cio
          echo "üîí Corrigindo permiss√µes de diret√≥rio..."
          chown -R bhs-crm:bhs-crm "$APP_PATH"
          chmod -R 775 "$APP_PATH"
          
          cd "$APP_PATH" || exit 1
          
          # 2. Sync C√≥digo
          git config --global --add safe.directory "$APP_PATH"
          git reset --hard HEAD
          git pull origin main
          
          # 3. Backend - Limpeza e Reinstala√ß√£o
          echo "‚öôÔ∏è Reinstalando Backend..."
          cd backend
          rm -f package-lock.json
          su - bhs-crm -c "cd $APP_PATH/backend && source ~/.nvm/nvm.sh && npm install"
          
          # 4. Restart PM2 e Logs
          echo "üìä Restarting PM2..."
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 restart crm-backend || pm2 start server.js --name crm-backend"
          
          # 5. Frontend - Limpeza e Rebuild
          echo "üé® Rebuildando Frontend..."
          cd ../frontend
          # Criar teste est√°tico
          mkdir -p public
          echo "<html><body><h1>CRM ONLINE - HEALTH CHECK OK ‚úÖ</h1></body></html>" > public/health.html
          
          rm -f package-lock.json
          rm -rf build
          su - bhs-crm -c "cd $APP_PATH/frontend && source ~/.nvm/nvm.sh && npm install && npm run build"
          
          # Copiar para build se n√£o foi autom√°tico
          cp public/health.html build/health.html 2>/dev/null || true
          
          # 6. Permiss√µes Finais para o Nginx
          chmod -R 755 build
          
          # 7. Restart Nginx e Status
          systemctl restart nginx
          echo "üìä PM2 Final Status:"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 list"
          echo "‚úÖ Deploy Finalizado!"
