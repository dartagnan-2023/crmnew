name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "ğŸš€ DEPLOY DIAGNÃ“STICO NGINX"
          APP_PATH="/home/bhseletrica-crm/htdocs/crm.bhseletrica.com.br"
          
          # 1. PermissÃµes de Travessia (Crucial para erro 500 no Nginx)
          echo "ğŸ”’ Garantindo permissÃµes de travessia..."
          # Nginx precisa de +x em todas as pastas do caminho
          chmod a+x /home/bhseletrica-crm
          chmod a+x /home/bhseletrica-crm/htdocs
          chmod a+x /home/bhseletrica-crm/htdocs/crm.bhseletrica.com.br
          
          # 2. Corrigir Owner e Recursividade
          chown -R bhs-crm:bhs-crm "$APP_PATH"
          chmod -R 755 "$APP_PATH"
          
          cd "$APP_PATH" || exit 1
          git config --global --add safe.directory "$APP_PATH"
          git reset --hard HEAD
          git pull origin main
          
          # 3. Backend (Garantir porta e inicializaÃ§Ã£o)
          cd backend
          su - bhs-crm -c "cd $APP_PATH/backend && source ~/.nvm/nvm.sh && npm install"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 restart crm-backend || pm2 start server.js --name crm-backend"
          
          # 4. Frontend
          cd ../frontend
          # Criar o health.html ANTES do build para ele ser incluÃ­do
          mkdir -p public
          echo "OK" > public/health.html
          su - bhs-crm -c "cd $APP_PATH/frontend && source ~/.nvm/nvm.sh && npm install && npm run build"
          
          # 5. PermissÃµes Finais Build
          chmod -R 755 build
          
          # 6. VerificaÃ§Ã£o de Arquivos
          echo "ğŸ“ Verificando BUILD:"
          ls -la build/index.html
          ls -la build/health.html
          
          # 7. Nginx - Testar ConfiguraÃ§Ã£o e Restart
          nginx -t
          systemctl restart nginx
          
          # 8. Ver logs de erro do Nginx para diagnosticar o 500
          echo "ğŸ“ ÃšLTIMOS ERROS DO NGINX:"
          tail -n 20 /var/log/nginx/error.log
          
          echo "âœ… Deploy Finalizado."
