name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "ðŸš€ TESTE DE EXTENSÃ•ES NGINX"
          APP_PATH="/home/bhseletrica-crm/htdocs/crm.bhseletrica.com.br"
          cd "$APP_PATH/frontend/build" || exit 1
          
          echo "DADOS DO SISTEMA" > debug_stats.txt
          date >> debug_stats.txt
          whoami >> debug_stats.txt
          
          echo "<html><body>HTML OK</body></html>" > health.html
          echo "TEXT OK" > health.txt
          
          # Garantir permissÃµes
          chmod 644 debug_stats.txt health.html health.txt
          
          # Verificar integridade do index.html
          if [ -f "index.html" ]; then
            echo "index.html existe" >> debug_stats.txt
            ls -la index.html >> debug_stats.txt
          else
            echo "index.html NAO EXISTE!" >> debug_stats.txt
          fi
          
          systemctl restart nginx
          echo "âœ… Fim do teste."
