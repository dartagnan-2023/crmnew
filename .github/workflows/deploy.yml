name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "ðŸš€ DEPLOY REPARO TOTAL"
          APP_PATH="/home/bhseletrica-crm/htdocs/crm.bhseletrica.com.br"
          
          # 1. PermissÃµes
          chown -R bhs-crm:www-data "$APP_PATH"
          chmod -R 775 "$APP_PATH"
          chmod a+x /home/bhseletrica-crm /home/bhseletrica-crm/htdocs
          
          cd "$APP_PATH" || exit 1
          git config --global --add safe.directory "$APP_PATH"
          git reset --hard HEAD
          git pull origin main
          
          # 2. Backend (ForÃ§ar HOST e PORT)
          echo "âš™ï¸ Backend..."
          cd backend
          su - bhs-crm -c "cd $APP_PATH/backend && source ~/.nvm/nvm.sh && npm install"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 delete crm-backend || true"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && PORT=3000 HOST=0.0.0.0 pm2 start server.js --name crm-backend"
          
          # 3. Frontend (ForÃ§ar build limpo)
          echo "ðŸŽ¨ Frontend..."
          cd ../frontend
          rm -rf build 2>/dev/null
          su - bhs-crm -c "cd $APP_PATH/frontend && source ~/.nvm/nvm.sh && npm install && npm run build"
          
          # 4. VerificaÃ§Ã£o de SaÃ­da
          echo "ðŸ“ Verificando index.html..."
          if [ -f "build/index.html" ]; then
            echo "âœ… Build OK."
          else
            echo "âŒ BUILD FAILED: index.html missing."
            exit 1
          fi
          
          # 5. PermissÃµes Nginx
          chmod -R 755 build
          chown -R bhs-crm:www-data build
          
          # 6. Nginx
          nginx -t && systemctl restart nginx
          
          # 7. DiagnÃ³stico Final (Exposto via JS)
          mkdir -p build/static/js
          echo "window.FINAL_DIAG = {" > build/static/js/final-diag.js
          echo "  nginx_errors: \`$(tail -n 50 /var/log/nginx/error.log | tr -d '`' | tr -d '$')\`," >> build/static/js/final-diag.js
          echo "  pm2_logs: \`$(su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 logs crm-backend --lines 50 --no-daemon" & PID=$!; sleep 5; kill $PID; wait $PID 2>/dev/null; tr -d '`' | tr -d '$')\`" >> build/static/js/final-diag.js
          echo "};" >> build/static/js/final-diag.js
          chmod 644 build/static/js/final-diag.js
          
          echo "âœ… SISTEMA RESTAURADO"
