name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "ðŸ”Ž DIAGNÃ“STICO PROFUNDO"
          APP_PATH="/home/bhseletrica-crm/htdocs/crm.bhseletrica.com.br"
          
          cd "$APP_PATH" || exit 1
          git config --global --add safe.directory "$APP_PATH"
          git reset --hard HEAD
          git pull origin main
          
          # 1. Backend
          cd backend
          su - bhs-crm -c "cd $APP_PATH/backend && source ~/.nvm/nvm.sh && npm install"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 delete crm-backend || true"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && PORT=3000 pm2 start server.js --name crm-backend"
          
          # 2. Frontend
          cd ../frontend
          rm -rf build node_modules
          su - bhs-crm -c "cd $APP_PATH/frontend && source ~/.nvm/nvm.sh && npm install && npm run build"
          
          # 3. InspeÃ§Ã£o de Arquivos
          echo "ðŸ“ Estado do BUILD:"
          ls -la build/
          echo "ðŸ“„ ConteÃºdo do index.html (Head):"
          head -c 500 build/index.html || echo "NÃ£o foi possÃ­vel ler index.html"
          
          # 4. InspeÃ§Ã£o de Rede
          echo "ðŸŒ Portas Ativas:"
          netstat -tunlp | grep -E "3000|3001"
          echo "ðŸ“Š PM2 Describe:"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 describe crm-backend"
          
          # 5. PermissÃµes Nginx e Restart
          chmod -R 755 build
          chown -R bhs-crm:www-data build
          
          # 6. Expor diagnÃ³stico via JS (Para ler via browser)
          mkdir -p build/static/js
          echo "window.SERVER_DIAG = {" > build/static/js/public-diag.js
          echo "  netstat: \`$(netstat -tunlp | grep -E "3000|3001" | tr -d '`' | tr -d '$')\`," >> build/static/js/public-diag.js
          echo "  ls_build: \`$(ls -la build/ | tr -d '`' | tr -d '$')\`," >> build/static/js/public-diag.js
          echo "  index_head: \`$(head -c 200 build/index.html | tr -d '`' | tr -d '$')\`," >> build/static/js/public-diag.js
          echo "  pm2: \`$(su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 jlist" | tr -d '`' | tr -d '$')\`" >> build/static/js/public-diag.js
          echo "};" >> build/static/js/public-diag.js
          chmod 644 build/static/js/public-diag.js
          
          nginx -t && systemctl restart nginx
          echo "âœ… Fim."
