name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          set -e
          echo "ğŸš€ INICIANDO DEPLOY COMPLETO"
          APP_PATH="/home/bhs-crm/htdocs/crm.bhseletrica.com.br"
          
          # 1. Atualizar cÃ³digo do repositÃ³rio
          echo "ğŸ“¥ Atualizando cÃ³digo..."
          cd "$APP_PATH"
          git reset --hard
          git pull origin main
          
          # 2. Restaurar e configurar .env do backend
          echo "âš™ï¸ Configurando backend..."
          cd "$APP_PATH/backend"
          if [ -f "/tmp/backend.env.backup" ]; then
            cp /tmp/backend.env.backup .env
            echo "âœ… .env restaurado do backup."
          else
            echo "âš ï¸ Backup nÃ£o encontrado. Usando .env atual."
          fi
          
          # 3. EnforÃ§ar PORT=3001
          sed -i 's/^PORT=.*/PORT=3001/' .env
          grep -q "^PORT=" .env || echo "PORT=3001" >> .env
          
          # 4. Instalar dependÃªncias do backend
          echo "ğŸ“¦ Instalando dependÃªncias do backend..."
          export NVM_DIR="/home/bhs-crm/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          npm install
          
          # 5. Reiniciar backend
          echo "ğŸ”„ Reiniciando backend..."
          
          # Limpeza agressiva: matar qualquer processo na porta 3001 (caso PM2 falhe)
          sudo fuser -k 3001/tcp || true
          
          # Verificar espaÃ§o em disco (evitar 502 por falta de logs/tmp)
          df -h | grep '^/'
          
          npx pm2 delete crm-backend || true
          npx pm2 start server.js --name crm-backend
          npx pm2 save
          
          # 6. Build do frontend
          echo "ğŸ¨ Buildando frontend..."
          cd "$APP_PATH/frontend"
          export NVM_DIR="/home/bhs-crm/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          npm install
          CI=false npm run build
          
          # 7. Copiar build para servir arquivos estÃ¡ticos
          echo "ğŸ“¦ Preparando arquivos estÃ¡ticos..."
          # Criar diretÃ³rio pÃºblico se nÃ£o existir
          sudo mkdir -p "$APP_PATH/public"
          # Limpar conteÃºdo antigo
          sudo rm -rf "$APP_PATH/public"/*
          # Copiar arquivos do build
          sudo cp -r build/* "$APP_PATH/public/"
          
          # 8. Ajustar permissÃµes
          echo "ğŸ” Ajustando permissÃµes..."
          sudo chown -R bhs-crm:www-data "$APP_PATH/public"
          sudo chmod -R 755 "$APP_PATH/public"
          
          # 9. Validar backend
          echo "ğŸ” Validando backend..."
          sleep 5
          npx pm2 status crm-backend
          curl -I http://127.0.0.1:3001/api/ping || { 
            echo "âŒ Backend nÃ£o responde em 127.0.0.1:3001."
            echo "ğŸ“‹ LOGS PM2:"
            npx pm2 logs crm-backend --lines 50 --no-daemon & sleep 5 && kill $!
            exit 1
          }
          
          # 10. Debugar e Corrigir Nginx
          echo "ğŸ“‹ Verificando configuraÃ§Ã£o do Nginx..."
          NGINX_CONF="/etc/nginx/sites-enabled/crm.bhseletrica.com.br.conf"
          
          if [ -f "$NGINX_CONF" ]; then
            echo "âœ… Arquivo Nginx encontrado. Auditando proxy_pass..."
            cat "$NGINX_CONF" | grep "proxy_pass"
            
            # Corrigir automaticamente se estiver usando localhost ou porta 3000
            echo "ğŸ”§ Aplicando correÃ§Ãµes preventivas no Nginx (Porta 3001 + IPv4)..."
            sudo sed -i 's/proxy_pass http:\/\/localhost:3000/proxy_pass http:\/\/127.0.0.1:3001/g' "$NGINX_CONF"
            sudo sed -i 's/proxy_pass http:\/\/127.0.0.1:3000/proxy_pass http:\/\/127.0.0.1:3001/g' "$NGINX_CONF"
            sudo sed -i 's/proxy_pass http:\/\/localhost:3001/proxy_pass http:\/\/127.0.0.1:3001/g' "$NGINX_CONF"
            
            echo "âœ… Nova configuraÃ§Ã£o (proxy_pass):"
            cat "$NGINX_CONF" | grep "proxy_pass"
          else
            echo "âš ï¸  Arquivo $NGINX_CONF nÃ£o encontrado. Pulando patch."
          fi
          
          echo "ğŸ“‹ Verificando quem estÃ¡ ouvindo nas portas..."
          sudo netstat -tulpn | grep LISTEN || true
          
          # 11. Reiniciar Nginx
          echo "ğŸŒ Reiniciando Nginx..."
          sudo nginx -t && sudo systemctl restart nginx
          
          echo "âœ… Deploy concluÃ­do!"
