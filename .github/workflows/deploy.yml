name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "ðŸš€ EXPOSING CONFIGS VIA JS"
          APP_PATH="/home/bhseletrica-crm/htdocs/crm.bhseletrica.com.br"
          JS_DEBUG_FILE="$APP_PATH/frontend/build/static/js/config-debug.js"
          
          # Garantir que a pasta exista
          mkdir -p "$APP_PATH/frontend/build/static/js"
          
          # Capturar dados (sem SSL keys)
          NGINX_CONF=$(cat /etc/nginx/sites-enabled/* | grep -v "ssl_certificate" | tr -d '`' | tr -d '$')
          PM2_LIST=$(su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 jlist" | tr -d '`' | tr -d '$')
          
          echo "window.SERVER_DEBUG = {" > "$JS_DEBUG_FILE"
          echo "  date: '$(date)'," >> "$JS_DEBUG_FILE"
          echo "  nginx_conf: \`$NGINX_CONF\`," >> "$JS_DEBUG_FILE"
          echo "  pm2_list: \`$PM2_LIST\`," >> "$JS_DEBUG_FILE"
          echo "  pwd: '$(pwd)'," >> "$JS_DEBUG_FILE"
          echo "  ls_root: \`$(ls -la "$APP_PATH")\`" >> "$JS_DEBUG_FILE"
          echo "};" >> "$JS_DEBUG_FILE"
          
          chmod 644 "$JS_DEBUG_FILE"
          echo "âœ… Configs exposed at static/js/config-debug.js"
          
          systemctl restart nginx
          echo "âœ… Fim."
