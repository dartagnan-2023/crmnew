name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "ðŸ” DIAGNÃ“STICO DE CONFIGURAÃ‡ÃƒO"
          
          # 1. Ver para onde o Nginx aponta
          echo "ðŸŒ Nginx Root Config:"
          grep -r "root" /etc/nginx/sites-enabled/ || echo "NÃ£o foi possÃ­vel ler as configs do Nginx."
          
          # 2. Ver processos PM2 e portas
          echo "ðŸ“Š PM2 Status:"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 list"
          netstat -tunlp | grep :3000
          netstat -tunlp | grep :3001
          
          # 3. Localizar onde estÃ¡ o git do crm
          echo "ðŸ“ Localizando diretÃ³rio git..."
          find /home -name ".git" -type d -prune 2>/dev/null | grep crm
          
          echo "âœ… Fim do diagnÃ³stico."
