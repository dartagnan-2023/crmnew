name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "üîé BUSCA GLOBAL E DIAGN√ìSTICO"
          
          # 1. Encontrar todos os index.html do CRM
          # Vamos procurar em /home/ e ver as datas
          find /home -name "index.html" -path "*build*" -ls > /tmp/search_results.txt
          
          # 2. Descobrir onde o Nginx est√° servindo /static/js/main.6ae19b05.js
          # Esse arquivo deu 200 OK nos testes do bot
          locate main.6ae19b05.js > /tmp/main_js_path.txt
          
          # 3. Mostrar configura√ß√µes do Nginx
          grep -r "root" /etc/nginx/sites-enabled/ > /tmp/nginx_roots.txt
          
          # 4. Tentar colocar esses logs em uma pasta que o Nginx est√° servindo
          # Se main.6ae19b05.js est√° em /path/to/static/js, 
          # vamos tentar colocar o log em /path/to/debug.txt
          WORKING_JS_PATH=$(head -n 1 /tmp/main_js_path.txt)
          if [ ! -z "$WORKING_JS_PATH" ]; then
            WORKING_DIR=$(dirname $(dirname $(dirname "$WORKING_JS_PATH")))
            echo "üéØ Pasta Nginx Prov√°vel: $WORKING_DIR"
            
            # Criar log l√°
            {
              echo "--- SEARCH RESULTS ---"
              cat /tmp/search_results.txt
              echo "--- NGINX ROOTS ---"
              cat /tmp/nginx_roots.txt
              echo "--- PM2 STATUS ---"
              su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 list"
            } > "$WORKING_DIR/debug-final.txt"
            
            chmod 644 "$WORKING_DIR/debug-final.txt"
            echo "‚úÖ Log salvo em $WORKING_DIR/debug-final.txt"
          else
            echo "‚ùå N√£o foi poss√≠vel localizar o arquivo JS vivo."
          fi
          
          echo "‚úÖ Fim da busca."
