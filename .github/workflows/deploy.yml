name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "üöÄ DEPLOY CORRETIVO - PORT 3000 & BUILD CHECK"
          APP_PATH="/home/bhseletrica-crm/htdocs/crm.bhseletrica.com.br"
          
          # 1. Permiss√µes e Travessia
          chown -R bhs-crm:www-data "$APP_PATH"
          chmod -R 775 "$APP_PATH"
          chmod a+x /home/bhseletrica-crm /home/bhseletrica-crm/htdocs
          
          cd "$APP_PATH" || exit 1
          git config --global --add safe.directory "$APP_PATH"
          git reset --hard HEAD
          git pull origin main
          
          # 2. Backend (For√ßar PORT 3000)
          echo "‚öôÔ∏è Backend..."
          cd backend
          su - bhs-crm -c "cd $APP_PATH/backend && source ~/.nvm/nvm.sh && npm install"
          # For√ßar vari√°vel de ambiente no PM2
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 delete crm-backend || true"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 start server.js --name crm-backend --env PORT=3000"
          
          # 3. Frontend
          echo "üé® Frontend..."
          cd ../frontend
          # Garantir que o build seja limpo
          rm -rf build
          su - bhs-crm -c "cd $APP_PATH/frontend && source ~/.nvm/nvm.sh && npm install && npm run build"
          
          # 4. Verifica√ß√£o Cr√≠tica de Arquivos
          if [ -f "build/index.html" ]; then
            echo "‚úÖ index.html encontrado!"
          else
            echo "‚ö†Ô∏è AVISO: index.html n√£o est√° no build. Tentando localizar..."
            find . -name "index.html"
          fi
          
          # 5. Permiss√µes Finais
          chmod -R 755 build
          chown -R bhs-crm:www-data build
          
          # 6. Nginx
          nginx -t && systemctl restart nginx
          echo "‚úÖ Deploy Finalizado!"
