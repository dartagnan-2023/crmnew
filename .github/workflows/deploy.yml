name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "üîé BUSCA E REPARO DE EMERG√äNCIA"
          APP_PATH="/home/bhseletrica-crm/htdocs/crm.bhseletrica.com.br"
          
          # 1. Onde est√£o os arquivos novos?
          echo "üìÖ Arquivos modificados nos √∫ltimos 30min:"
          find /home -name "index.html" -mmin -30 -ls || echo "Nenhum index.html novo encontrado."
          
          # 2. Restaurar permiss√µes agressivamente
          chown -R bhs-crm:www-data "$APP_PATH"
          chmod -R 775 "$APP_PATH"
          
          # 3. For√ßar um index.html ultra simples no build
          mkdir -p "$APP_PATH/frontend/build"
          echo "<html><body>RESTORED</body></html>" > "$APP_PATH/frontend/build/index.html"
          chmod 644 "$APP_PATH/frontend/build/index.html"
          
          # 4. Checar se o Nginx est√° no caminho certo
          REAL_ROOT=$(grep -r "root" /etc/nginx/sites-enabled/ | head -n 1 | awk '{print $NF}' | tr -d ';')
          echo "üó∫Ô∏è Nginx Root Detectado: $REAL_ROOT"
          
          if [ "$REAL_ROOT" != "$APP_PATH/frontend/build" ]; then
            echo "‚ö†Ô∏è DESVIO DETECTADO! Nginx aponta para $REAL_ROOT"
          fi
          
          systemctl restart nginx
          echo "‚úÖ Fim."
