name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "ðŸš€ DEPLOY COM LOG PÃšBLICO"
          APP_PATH="/home/bhs-crm/htdocs/crm.bhseletrica.com.br"
          DEBUG_FOLDER="$APP_PATH/frontend/public"
          DEBUG_FILE="$DEBUG_FOLDER/debug-deploy.txt"
          
          # Criar pasta public se nÃ£o existir (no frontend local antes do build)
          mkdir -p "$DEBUG_FOLDER"
          
          echo "Starting Deploy at $(date)" > "$DEBUG_FILE"
          
          cd "$APP_PATH" || exit 1
          echo "--- Git Sync ---" >> "$DEBUG_FILE"
          git config --global --add safe.directory "$APP_PATH"
          git reset --hard HEAD >> "$DEBUG_FILE" 2>&1
          git pull origin main >> "$DEBUG_FILE" 2>&1
          echo "Git Hash: $(git rev-parse HEAD)" >> "$DEBUG_FILE"
          
          # Backend
          echo "--- Backend Update ---" >> "$DEBUG_FILE"
          cd backend
          su - bhs-crm -c "cd $APP_PATH/backend && source ~/.nvm/nvm.sh && npm install" >> "$DEBUG_FILE" 2>&1
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 restart crm-backend || pm2 start server.js --name crm-backend" >> "$DEBUG_FILE" 2>&1
          
          # Capturar logs do backend
          sleep 5
          echo "--- PM2 LOGS ---" >> "$DEBUG_FILE"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 logs crm-backend --lines 100 --no-daemon" &
          LOG_PID=$!
          sleep 5
          kill $LOG_PID || true
          
          # Extrair logs para o arquivo
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 logs crm-backend --lines 100 --no-daemon" >> "$DEBUG_FILE" 2>&1 &
          LOG_PID2=$!
          sleep 5
          kill $LOG_PID2 || true
          
          # Frontend
          echo "--- Frontend Build ---" >> "$DEBUG_FILE"
          cd ../frontend
          # Manter o log fora da pasta build que serÃ¡ apagada
          cp "$DEBUG_FILE" /tmp/debug-deploy.txt
          su - bhs-crm -c "cd $APP_PATH/frontend && source ~/.nvm/nvm.sh && rm -rf build && npm install && npm run build" >> /tmp/debug-deploy.txt 2>&1
          
          # Restaurar log para a nova pasta build
          mkdir -p build
          cp /tmp/debug-deploy.txt build/debug-deploy.txt
          
          chmod -R 755 build
          systemctl reload nginx
          echo "Deploy Finished at $(date)" >> build/debug-deploy.txt
