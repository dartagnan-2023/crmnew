name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "ğŸš€ INICIANDO DEPLOY COMPLETO"
          APP_PATH="/home/bhs-crm/htdocs/crm.bhseletrica.com.br"
          
          # 1. Atualizar cÃ³digo do repositÃ³rio
          echo "ğŸ“¥ Atualizando cÃ³digo..."
          cd "$APP_PATH" || exit 1
          su - bhs-crm -c "cd $APP_PATH && git pull origin main"
          
          # 2. Restaurar e configurar .env do backend
          echo "âš™ï¸ Configurando backend..."
          cd "$APP_PATH/backend" || exit 1
          if [ -f "/tmp/backend.env.backup" ]; then
            cp /tmp/backend.env.backup .env
            echo "âœ… .env restaurado do backup."
          else
            echo "âš ï¸ Backup nÃ£o encontrado. Usando .env atual."
          fi
          
          # 3. EnforÃ§ar PORT=3000
          sed -i 's/^PORT=.*/PORT=3000/' .env
          grep -q "^PORT=" .env || echo "PORT=3000" >> .env
          
          # 4. Instalar dependÃªncias e reiniciar backend
          echo "ğŸ”„ Reiniciando backend..."
          su - bhs-crm -c "cd $APP_PATH/backend && source ~/.nvm/nvm.sh && npm install"
          su - bhs-crm -c "cd $APP_PATH/backend && source ~/.nvm/nvm.sh && pm2 delete crm-backend || true"
          su - bhs-crm -c "cd $APP_PATH/backend && source ~/.nvm/nvm.sh && pm2 start server.js --name crm-backend"
          
          # 5. Build do frontend
          echo "ğŸ¨ Buildando frontend..."
          su - bhs-crm -c "cd $APP_PATH/frontend && source ~/.nvm/nvm.sh && npm install && CI=false npm run build"
          
          # 6. Copiar build para diretÃ³rio pÃºblico
          echo "ğŸ“¦ Copiando arquivos para produÃ§Ã£o..."
          rm -rf /home/bhs-crm/htdocs/crm.bhseletrica.com.br/public_html/*
          cp -r $APP_PATH/frontend/build/* /home/bhs-crm/htdocs/crm.bhseletrica.com.br/public_html/
          
          # 7. Ajustar permissÃµes
          chown -R bhs-crm:www-data /home/bhs-crm/htdocs/crm.bhseletrica.com.br/public_html
          chmod -R 755 /home/bhs-crm/htdocs/crm.bhseletrica.com.br/public_html
          
          # 8. Validar backend
          echo "ğŸ” Validando backend..."
          sleep 5
          curl -I http://localhost:3000/api/ping || echo "âŒ Backend nÃ£o responde."
          
          # 9. Reiniciar Nginx
          echo "ğŸŒ Reiniciando Nginx..."
          nginx -t && systemctl restart nginx
          
          echo "âœ… Deploy concluÃ­do!"
