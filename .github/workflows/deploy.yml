name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "ðŸš€ DEPLOY REPARO FINAL"
          APP_PATH="/home/bhseletrica-crm/htdocs/crm.bhseletrica.com.br"
          
          cd "$APP_PATH" || exit 1
          chown -R bhs-crm:bhseletrica-crm .
          
          # 1. Liberar portas
          fuser -k 3000/tcp || true
          fuser -k 3001/tcp || true
          
          # 2. Frontend Build (Com log)
          cd frontend
          rm -rf build
          su - bhs-crm -c "cd $APP_PATH/frontend && source ~/.nvm/nvm.sh && CI=false npm install && CI=false npm run build > build.log 2>&1"
          
          # 3. Expor log do build se falhar
          mkdir -p build/static/js
          echo "window.BUILD_LOG = \`$(cat build.log | tr -d '`' | tr -d '$' | tail -n 100)\`;" > build/static/js/build-log.js
          
          # 4. Backend
          cd ../backend
          su - bhs-crm -c "cd $APP_PATH/backend && source ~/.nvm/nvm.sh && npm install"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 delete crm-backend || true"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && PORT=3000 pm2 start server.js --name crm-backend"
          
          # 5. PermissÃµes e Nginx
          cd ..
          chown -R bhs-crm:www-data "$APP_PATH/frontend/build"
          chmod -R 755 "$APP_PATH/frontend/build"
          nginx -t && systemctl restart nginx
          echo "âœ… Fim."
