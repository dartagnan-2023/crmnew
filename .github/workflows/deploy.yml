name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
          echo "üöÄ FIX BACKEND PORT 3000"
          APP_PATH="/home/bhseletrica-crm/htdocs/crm.bhseletrica.com.br"
          
          cd "$APP_PATH/backend" || exit 1
          
          # 1. For√ßar PORT=3000 no .env
          if [ -f ".env" ]; then
            sed -i 's/^PORT=.*/PORT=3000/' .env
            grep -q "^PORT=" .env || echo "PORT=3000" >> .env
          else
            echo "PORT=3000" > .env
          fi
          
          # 2. Reiniciar Backend
          su - bhs-crm -c "cd $APP_PATH/backend && source ~/.nvm/nvm.sh && npm install"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 delete crm-backend || true"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 start server.js --name crm-backend"
          
          # 3. Verifica√ß√£o de Rede
          echo "üåê Portas Ativas:"
          netstat -tunlp | grep :3000
          
          # 4. Nginx
          nginx -t && systemctl restart nginx
          echo "‚úÖ SISTEMA RESTAURADO"
