name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 20m
        script: |
        script: |
          echo "üîç INFO: Iniciando recupera√ß√£o e descoberta..."
          echo "Usuario SSH: $(whoami)"
          
          # Tentar entrar no diretorio
          if cd ${{ secrets.VPS_APP_PATH }}; then
            echo "‚úÖ Entrou em VPS_APP_PATH: $(pwd)"
          elif cd /home/bhs-crm/htdocs/crm.bhseletrica.com.br; then
            echo "‚úÖ Entrou em /home/bhs-crm/... : $(pwd)"
          else
            echo "‚ùå FALHA: N√£o foi poss√≠vel encontrar o diret√≥rio da aplica√ß√£o."
            exit 1
          fi
          
          # Atualizar c√≥digo do GitHub
          git config --global --add safe.directory $(pwd)
          git reset --hard HEAD
          git pull origin main
          
          # Log da vers√£o
          echo "üìç Vers√£o atual (git): $(git log -1 --oneline)"
          
          # DEBUG: Ver se o usuario bhs-crm consegue ver os arquivos
          echo "ÔøΩ Permiss√µes da pasta atual:"
          ls -ld .
          
          # Atualizar backend (SEM apagar node_modules desta vez)
          echo "‚öôÔ∏è Atualizando backend..."
          cd backend
          su - bhs-crm -c "cd $(pwd) && source ~/.nvm/nvm.sh && npm install --no-audit --no-fund"
          
          # Reiniciar e verificar PM2
          echo "üìä Reiniciando PM2..."
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 restart crm-backend || pm2 start server.js --name crm-backend"
          
          # Esperar o backend subir e ver logs se houver erro
          sleep 5
          echo "üìù Ultimas linhas do Log do PM2:"
          su - bhs-crm -c "source ~/.nvm/nvm.sh && pm2 logs crm-backend --lines 20 --no-daemon" &
          LOG_PID=$!
          sleep 3
          kill $LOG_PID || true
          
          # Atualizar frontend
          echo "üé® Atualizando frontend..."
          cd ../frontend
          # Somente reinstalar se necess√°rio para economizar tempo e evitar falhas
          su - bhs-crm -c "cd $(pwd) && source ~/.nvm/nvm.sh && npm install --no-audit --no-fund && npm run build"
          
          # Garantir que o Nginx consiga ler
          chmod -R 755 build
          
          # Recarregar Nginx
          systemctl reload nginx
          
          echo "‚úÖ Deploy finalizado."
